<div class="mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h3>Quản lý Slide</h3>
        <div class="d-flex gap-2">
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="slideSearch" placeholder="Tìm kiếm slide...">
                <button class="btn btn-outline-secondary border-start-0 bg-transparent d-none" type="button"
                    id="clearSearch" style="margin-left: -1px;">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#selectSlideTypeModal">
                <i class="bi bi-plus-circle"></i> Thêm slide mới
            </button>
        </div>
    </div>

    <!-- Slide Desktop -->
    <div class="mt-4">
        <h4 class="mb-3">Slide Desktop</h4>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Tiêu đề</th>
                    <th scope="col">Hình ảnh</th>
                    <th scope="col">Đường dẫn</th>
                    <th scope="col">Thứ tự hiển thị</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each slides}}
                {{#if (eq this.type 'desktop')}}
                <tr>
                    <th scope="row">{{sum @index 1}}</th>
                    <td>{{this.title}}</td>
                    <td>
                        <img src="{{this.imageUrl}}" alt="{{this.title}}" class="img-thumbnail"
                            style="max-width: 100px;">
                    </td>
                    <td>{{this.link}}</td>
                    <td>{{this.order}}</td>
                    <td>
                        {{#if this.active}}
                        <span class="badge bg-success">Hiển thị</span>
                        {{else}}
                        <span class="badge bg-secondary">Ẩn</span>
                        {{/if}}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-slide-btn" data-id="{{this._id}}"
                            data-title="{{this.title}}" data-image="{{this.imageUrl}}" data-link="{{this.link}}"
                            data-order="{{this.order}}" data-active="{{this.active}}" data-type="{{this.type}}" data-bs-toggle="modal"
                            data-bs-target="#editSlideModal">
                            <i class="bi bi-pencil"></i> Sửa
                        </button>
                        <button class="btn btn-sm btn-danger" data-id="{{this._id}}" data-title="{{this.title}}"
                            data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Xóa
                        </button>
                    </td>
                </tr>
                {{/if}}
                {{else}}
                <tr>
                    <td colspan="7" class="text-center">Chưa có slide desktop nào.</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Slide Mobile -->
    <div class="mt-4">
        <h4 class="mb-3">Slide Mobile</h4>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Tiêu đề</th>
                    <th scope="col">Hình ảnh</th>
                    <th scope="col">Đường dẫn</th>
                    <th scope="col">Thứ tự hiển thị</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each slides}}
                {{#if (eq this.type 'mobile')}}
                <tr>
                    <th scope="row">{{sum @index 1}}</th>
                    <td>{{this.title}}</td>
                    <td>
                        <img src="{{this.imageUrl}}" alt="{{this.title}}" class="img-thumbnail"
                            style="max-width: 100px;">
                    </td>
                    <td>{{this.link}}</td>
                    <td>{{this.order}}</td>
                    <td>
                        {{#if this.active}}
                        <span class="badge bg-success">Hiển thị</span>
                        {{else}}
                        <span class="badge bg-secondary">Ẩn</span>
                        {{/if}}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-slide-btn" data-id="{{this._id}}"
                            data-title="{{this.title}}" data-image="{{this.imageUrl}}" data-link="{{this.link}}"
                            data-order="{{this.order}}" data-active="{{this.active}}" data-type="{{this.type}}" data-bs-toggle="modal"
                            data-bs-target="#editSlideModal">
                            <i class="bi bi-pencil"></i> Sửa
                        </button>
                        <button class="btn btn-sm btn-danger" data-id="{{this._id}}" data-title="{{this.title}}"
                            data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Xóa
                        </button>
                    </td>
                </tr>
                {{/if}}
                {{else}}
                <tr>
                    <td colspan="7" class="text-center">Chưa có slide mobile nào.</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Select Slide Type Modal -->
<div class="modal fade" id="selectSlideTypeModal" tabindex="-1" aria-labelledby="selectSlideTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectSlideTypeModalLabel">Chọn loại slide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-lg btn-primary" id="selectDesktopSlide">
                        <i class="bi bi-display"></i> Slide Desktop
                    </button>
                    <button class="btn btn-lg btn-info" id="selectMobileSlide">
                        <i class="bi bi-phone"></i> Slide Mobile
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Slide Modal -->
<div class="modal fade" id="addSlideModal" tabindex="-1" aria-labelledby="addSlideModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSlideModalLabel">Thêm slide mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form autocomplete="off" method="post" action="/slides" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="slideType" name="type" value="">
                    <div class="mb-3">
                        <label for="addTitle" class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" id="addTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="addImage" class="form-label">Hình ảnh</label>
                        <input class="form-control" type="file" id="addImage" name="image" accept="image/*" required>
                        <!-- Hiển thị ảnh preview -->
                        <div class="mt-2">
                            <img id="addImagePreview" src="" alt="Ảnh xem trước"
                                style="max-width: 100%; max-height: 200px; display: none;" class="img-thumbnail">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addLink" class="form-label">Đường dẫn</label>
                        <input type="text" class="form-control" id="addLink" name="link">
                    </div>
                    <div class="mb-3">
                        <label for="addOrder" class="form-label">Thứ tự hiển thị</label>
                        <input type="number" class="form-control" id="addOrder" name="order" min="1" value="1" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="addActive" name="active" checked>
                        <label class="form-check-label" for="addActive">Hiển thị slide</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Thêm slide</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Slide Modal -->
<div class="modal fade" id="editSlideModal" tabindex="-1" aria-labelledby="editSlideModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSlideModalLabel">Sửa slide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editSlideForm" autocomplete="off" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editImage" class="form-label">Hình ảnh</label>
                        <input class="form-control" type="file" id="editImage" name="image" accept="image/*">
                        <!-- Hiển thị ảnh hiện tại -->
                        <div class="mt-2">
                            <p class="text-muted">Ảnh hiện tại:</p>
                            <img id="currentImage" src="" alt="Ảnh hiện tại" class="img-thumbnail"
                                style="max-width: 100%; max-height: 200px;">
                        </div>
                        <!-- Hiển thị ảnh preview -->
                        <div class="mt-2">
                            <p class="text-muted">Ảnh mới (nếu có):</p>
                            <img id="editImagePreview" src="" alt="Ảnh xem trước"
                                style="max-width: 100%; max-height: 200px; display: none;" class="img-thumbnail">
                        </div>
                        <!-- Lưu URL ảnh hiện tại -->
                        <input type="hidden" id="currentImageUrl" name="currentImageUrl">
                    </div>
                    <div class="mb-3">
                        <label for="editLink" class="form-label">Đường dẫn</label>
                        <input type="text" class="form-control" id="editLink" name="link">
                    </div>
                    <div class="mb-3">
                        <label for="editOrder" class="form-label">Thứ tự hiển thị</label>
                        <input type="number" class="form-control" id="editOrder" name="order" min="1" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editActive" name="active">
                        <label class="form-check-label" for="editActive">Hiển thị slide</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn xóa slide "<span id="slideTitleToDelete"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden delete form -->
<form id="deleteForm" method="POST" style="display: none;"></form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Xử lý chọn loại slide
        const selectSlideTypeModal = document.getElementById('selectSlideTypeModal');
        const addSlideModal = document.getElementById('addSlideModal');
        const selectDesktopSlide = document.getElementById('selectDesktopSlide');
        const selectMobileSlide = document.getElementById('selectMobileSlide');
        const slideTypeInput = document.getElementById('slideType');
        const addSlideModalLabel = document.getElementById('addSlideModalLabel');
        
        // Khởi tạo Bootstrap Modal
        const selectTypeModal = new bootstrap.Modal(selectSlideTypeModal);
        const addSlideModalInstance = new bootstrap.Modal(addSlideModal);
        
        selectDesktopSlide.addEventListener('click', function() {
            slideTypeInput.value = 'desktop';
            addSlideModalLabel.textContent = 'Thêm slide Desktop';
            selectTypeModal.hide();
            setTimeout(() => {
                addSlideModalInstance.show();
            }, 150);
        });
        
        selectMobileSlide.addEventListener('click', function() {
            slideTypeInput.value = 'mobile';
            addSlideModalLabel.textContent = 'Thêm slide Mobile';
            selectTypeModal.hide();
            setTimeout(() => {
                addSlideModalInstance.show();
            }, 150);
        });

        // Xử lý đóng modal khi click nút close hoặc nút Hủy
        const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
        });

        // Xử lý preview ảnh khi thêm mới
        document.getElementById('addImage').addEventListener('change', function (event) {
            const imagePreview = document.getElementById('addImagePreview');
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
        });

        // Xử lý preview ảnh khi chỉnh sửa
        document.getElementById('editImage').addEventListener('change', function (event) {
            const imagePreview = document.getElementById('editImagePreview');
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
        });

        // Xử lý xóa slide
        const deleteModal = document.getElementById('deleteModal');
        const slideTitleToDelete = document.getElementById('slideTitleToDelete');
        const deleteForm = document.getElementById('deleteForm');
        const confirmDelete = document.getElementById('confirmDelete');
        let slideIdToDelete;

        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            slideIdToDelete = button.getAttribute('data-id');
            const slideTitle = button.getAttribute('data-title');
            slideTitleToDelete.textContent = slideTitle;
        });

        confirmDelete.addEventListener('click', function () {
            deleteForm.action = `/slides/${slideIdToDelete}?_method=DELETE`;
            deleteForm.submit();
        });

        // Xử lý chỉnh sửa slide
        const editSlideModal = document.getElementById('editSlideModal');
        const editSlideForm = document.getElementById('editSlideForm');
        const currentImage = document.getElementById('currentImage');
        const currentImageUrl = document.getElementById('currentImageUrl');
        const editTitle = document.getElementById('editTitle');
        const editLink = document.getElementById('editLink');
        const editOrder = document.getElementById('editOrder');
        const editActive = document.getElementById('editActive');

        editSlideModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const slideId = button.getAttribute('data-id');
            const slideTitle = button.getAttribute('data-title');
            const slideImage = button.getAttribute('data-image');
            const slideLink = button.getAttribute('data-link');
            const slideOrder = button.getAttribute('data-order');
            const slideActive = button.getAttribute('data-active') === 'true';
            const slideType = button.getAttribute('data-type');

            editSlideForm.action = `/slides/${slideId}?_method=PUT`;
            editTitle.value = slideTitle;
            currentImage.src = slideImage;
            currentImageUrl.value = slideImage;
            editLink.value = slideLink;
            editOrder.value = slideOrder;
            editActive.checked = slideActive;

            // Reset preview ảnh mới
            document.getElementById('editImagePreview').style.display = 'none';
        });

        // Xử lý nút xóa nội dung tìm kiếm
        const slideSearchInput = document.getElementById('slideSearch');
        const clearSearchBtn = document.getElementById('clearSearch');

        // Hiển thị nút xóa khi có nội dung
        slideSearchInput.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                clearSearchBtn.classList.remove('d-none');
            } else {
                clearSearchBtn.classList.add('d-none');
            }
            
            // Tìm kiếm slide
            const searchText = this.value.toLowerCase().trim();
            const tableRows = document.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                if (row.querySelector('td:nth-child(2)')) {
                    const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const link = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    
                    if (title.includes(searchText) || link.includes(searchText) || searchText === '') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });

        // Xử lý khi click vào nút xóa
        clearSearchBtn.addEventListener('click', function() {
            slideSearchInput.value = '';
            clearSearchBtn.classList.add('d-none');
            // Kích hoạt sự kiện input để cập nhật kết quả tìm kiếm
            slideSearchInput.dispatchEvent(new Event('input'));
            // Focus lại vào ô tìm kiếm
            slideSearchInput.focus();
        });
    });
</script>